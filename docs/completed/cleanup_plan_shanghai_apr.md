# 上海4月奖励函数清理计划

## 📋 当前状态

### ✅ 已完成
- **生产代码替换**：`determine_rewards_shanghai_apr` → `determine_rewards_apr_shanghai_generic`
- **功能验证**：所有等价性测试通过
- **幸运奖禁用**：采用方案一，完全禁用幸运奖
- **弃用标记**：原函数已标记为 `@deprecated`

### 📊 函数使用情况分析

#### 🚫 原函数 `determine_rewards_shanghai_apr`
- **生产代码**：✅ 已完全替换，无调用
- **测试代码**：⚠️ 仅在等价性测试中使用
- **状态**：已弃用，仅保留用于验证

#### ✅ 新函数 `determine_rewards_apr_shanghai_generic`
- **生产代码**：✅ 正在使用（第402行）
- **测试代码**：✅ 所有新测试都使用此函数
- **状态**：活跃，推荐使用

## 🗑️ 清理计划

### 阶段一：立即执行（已完成）
- [x] 添加弃用标记到原函数
- [x] 更新测试用例，移除幸运奖相关的期望
- [x] 验证所有测试通过

### 阶段二：短期清理（1-2周后）
- [ ] 移除等价性测试文件 `test_shanghai_apr_equivalence.py`
- [ ] 从 `test_rewards.py` 中移除过时的幸运奖测试用例
- [ ] 更新文档，移除幸运奖相关的说明

### 阶段三：长期清理（1个月后）
- [ ] 完全删除原函数 `determine_rewards_shanghai_apr`
- [ ] 清理相关的导入语句
- [ ] 更新所有文档引用

## 📁 需要清理的文件

### 测试文件
```
tests/test_shanghai_apr_equivalence.py  # 可以删除
tests/test_rewards.py                   # 需要更新，移除幸运奖测试
tests/test_integration_shanghai_apr.py # 已更新
tests/test_shanghai_apr_no_lucky.py    # 保留
```

### 文档文件
```
docs/05_testing_approach.md            # 需要更新
docs/project_management/               # 需要更新状态
```

### 代码文件
```
modules/data_processing_module.py       # 最终删除原函数
```

## ⚠️ 注意事项

1. **保守清理**：由于是生产环境，建议分阶段清理
2. **测试覆盖**：确保新函数的测试覆盖率不低于原函数
3. **文档同步**：及时更新相关文档
4. **团队通知**：清理前通知团队成员

## 🎯 清理收益

### 代码质量
- 减少约100行冗余代码
- 消除硬编码逻辑
- 统一架构模式

### 维护成本
- 减少重复测试
- 简化配置管理
- 降低bug风险

### 团队效率
- 新人更容易理解
- 减少混淆和错误使用
- 提高开发效率

## 📝 执行记录

| 日期 | 阶段 | 操作 | 状态 |
|------|------|------|------|
| 2025-01-XX | 阶段一 | 添加弃用标记 | ✅ 完成 |
| 2025-01-XX | 阶段一 | 更新测试用例 | ✅ 完成 |
| 2025-01-XX | 阶段一 | 验证功能 | ✅ 完成 |
| TBD | 阶段二 | 移除等价性测试 | ⏳ 待执行 |
| TBD | 阶段三 | 删除原函数 | ⏳ 待执行 |

---

**总结**：原函数 `determine_rewards_shanghai_apr` 理论上已经无用，建议按照此计划分阶段清理，确保生产环境的稳定性。
