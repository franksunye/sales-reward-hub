# 阶段1：上海9月Job详细验证计划

**Job代码**: SH-SEP-2025  
**Job名称**: 上海9月销售激励（双轨统计）  
**验证类型**: 真实数据逐字段验证  
**优先级**: 高（紧随北京9月）

## 📋 验证目标

### 核心目标
1. **双轨统计正确**: 平台单/自引单分类和统计100%正确
2. **字段完全一致**: 每个字段值与旧系统100%一致
3. **项目地址去重**: 自引单地址去重逻辑正确
4. **自引单奖励**: 自引单特殊奖励计算正确

### 验证范围
- **双轨分类**: 平台单/自引单的正确分类
- **项目地址去重**: 同管家同地址的去重逻辑
- **管家键格式**: "管家_服务商"格式的正确使用
- **自引单奖励**: 自引单特有的奖励逻辑
- **累计统计**: 分轨道的累计统计

## 🔍 详细验证检查点

### 1. 基础字段验证（与北京相同）
每个合同记录必须验证的字段：

#### 1.1 标识字段
- [ ] **合同ID(_id)**: 唯一标识，必须完全匹配
- [ ] **活动编号**: 必须为"SH-SEP"
- [ ] **工单编号(serviceAppointmentNum)**: 工单标识

#### 1.2 主体信息字段
- [ ] **管家(serviceHousekeeper)**: 管家姓名
- [ ] **服务商(orgName)**: 服务商名称
- [ ] **项目地址(projectAddress)**: 项目地址（上海特有重要字段）

#### 1.3 金额字段（精确验证）
- [ ] **合同金额(adjustRefundMoney)**: 原始合同金额
- [ ] **支付金额(paidAmount)**: 实际支付金额
- [ ] **计入业绩金额**: 最终计入业绩的金额

#### 1.4 双轨统计字段（上海特有）
- [ ] **款项来源类型(tradeIn)**: 0=平台单，1=自引单
- [ ] **工单类型**: 平台单/自引单分类
- [ ] **平台单累计单数**: 管家平台单累计数量
- [ ] **平台单累计金额**: 管家平台单累计金额
- [ ] **自引单累计单数**: 管家自引单累计数量
- [ ] **自引单累计金额**: 管家自引单累计金额

### 2. 上海特有业务逻辑验证

#### 2.1 双轨统计逻辑
- [ ] **分类准确性**: 根据tradeIn字段正确分类
- [ ] **平台单统计**: 平台单的数量和金额统计
- [ ] **自引单统计**: 自引单的数量和金额统计
- [ ] **总计统计**: 平台单+自引单的总计统计
- [ ] **分轨道累计**: 每个轨道独立的累计计算

#### 2.2 项目地址去重逻辑
- [ ] **去重规则**: 同管家+同项目地址的自引单去重
- [ ] **地址标准化**: 项目地址的标准化处理
- [ ] **去重效果**: 重复地址的正确处理
- [ ] **保留逻辑**: 去重时保留哪一条记录的逻辑

#### 2.3 管家键格式（上海特有）
- [ ] **键格式**: 使用"管家_服务商"格式
- [ ] **键唯一性**: 管家键的唯一性保证
- [ ] **累计基础**: 基于管家键的累计统计
- [ ] **跨服务商**: 同管家不同服务商的分别统计

#### 2.4 自引单特殊奖励
- [ ] **自引单奖励**: 自引单特有的奖励类型
- [ ] **奖励条件**: 自引单奖励的触发条件
- [ ] **奖励计算**: 自引单奖励金额的计算
- [ ] **奖励组合**: 自引单奖励与其他奖励的组合

### 3. 双轨统计CSV验证

#### 3.1 CSV文件格式
- [ ] **文件命名**: performance_data_SH-SEP_dual_track_*.csv
- [ ] **字段完整**: 包含所有双轨统计字段
- [ ] **数据格式**: UTF-8编码，标准CSV格式

#### 3.2 双轨统计字段
- [ ] **平台单字段**: 平台单相关的所有统计字段
- [ ] **自引单字段**: 自引单相关的所有统计字段
- [ ] **总计字段**: 总计统计字段的正确性

#### 3.3 数据一致性
- [ ] **分轨道一致**: 分轨道数据与总计数据一致
- [ ] **累计一致**: 累计数据与明细数据一致
- [ ] **去重一致**: 去重后的数据一致性

## 📊 验证方法和工具

### 专用验证工具
1. **dual_track_validator.py**: 双轨统计专用验证工具
2. **address_dedup_checker.py**: 项目地址去重检查工具
3. **self_referral_reward_validator.py**: 自引单奖励验证工具

### 验证数据源
1. **基准数据**: 旧系统的双轨统计输出
2. **API原始数据**: Metabase API返回的原始数据
3. **中间处理数据**: 各个处理步骤的中间结果

### 特殊验证点
1. **tradeIn字段**: 0/1值的正确性和完整性
2. **项目地址**: 地址字段的完整性和格式
3. **管家_服务商**: 组合键的正确生成
4. **自引单标识**: 自引单的正确识别

## 📈 成功标准

### 双轨统计标准
- **分类准确率**: 100%正确分类平台单/自引单
- **统计准确率**: 100%准确的分轨道统计
- **去重准确率**: 100%正确的地址去重
- **累计准确率**: 100%准确的累计计算

### 数据一致性标准
- **关键字段**: 100%一致
- **双轨字段**: 100%一致
- **奖励字段**: 100%一致
- **地址字段**: 100%一致（标准化后）

## 🚨 特殊风险点

### 上海特有风险
1. **双轨分类**: tradeIn字段可能存在异常值
2. **地址去重**: 地址格式不统一可能影响去重
3. **管家键**: 管家名或服务商名包含特殊字符
4. **自引单奖励**: 复杂的自引单奖励逻辑

### 数据质量风险
1. **地址缺失**: 项目地址字段为空的处理
2. **服务商变更**: 同管家不同服务商的处理
3. **历史数据**: 历史数据的双轨统计处理

## 📋 执行计划（端到端测试流程）

### 第1步：环境初始化（预计1小时）
- [ ] **清空新系统数据库**：
  ```sql
  DELETE FROM performance_records WHERE activity_code = 'SH-SEP';
  DELETE FROM notification_queue WHERE activity_code = 'SH-SEP';
  ```
- [ ] **验证数据库状态**：确认相关表为空
- [ ] **API连接测试**：确认上海Metabase API正常响应
- [ ] **配置文件检查**：验证API_URL_SH_SEP等配置
- [ ] **双轨统计环境**：确认双轨统计相关配置正确

### 第2步：获取基准数据（预计2小时）
- [ ] **准备旧系统环境**：
  - 清空旧系统数据库（如果使用）
  - 确保使用相同的API数据源
- [ ] **执行旧系统完整流程**：
  - 运行旧系统的SH-SEP Job（双轨统计版本）
  - 记录执行时间和处理记录数
  - 特别关注双轨统计的处理过程
- [ ] **收集基准输出**：
  - 保存生成的双轨统计CSV文件为baseline
  - 记录平台单/自引单的分类结果
  - 记录项目地址去重的处理结果
  - 记录自引单奖励的计算结果
- [ ] **基准数据验证**：
  - 检查双轨统计字段的完整性
  - 验证地址去重逻辑的正确性
  - 备份基准数据到专用目录

### 第3步：执行新系统（预计1小时）
- [ ] **再次确认环境干净**：
  - 验证新系统数据库为空
  - 确认无残留的临时文件
- [ ] **执行新架构完整流程**：
  - 运行 `signing_and_sales_incentive_sep_shanghai_v2()`
  - 记录执行时间和处理记录数
  - 监控双轨统计的处理过程
- [ ] **收集测试输出**：
  - 保存生成的双轨统计CSV文件
  - 导出数据库中的performance_records
  - 导出notification_queue中的通知记录
  - 特别收集双轨统计相关的中间数据
- [ ] **执行状态检查**：
  - 确认无异常和错误
  - 验证双轨统计CSV文件格式正确

### 第4步：双轨统计专项验证（预计4小时）
- [ ] **文件级初步对比**：
  - 比较双轨统计CSV文件行数
  - 比较文件大小和格式
- [ ] **双轨分类验证**：
  ```bash
  python scripts/dual_track_validator.py \
    --baseline baseline/performance_data_SH-SEP_dual_track_baseline.csv \
    --current performance_data_SH-SEP_dual_track_*.csv \
    --output reports/sh_sep_dual_track_validation.md
  ```
- [ ] **项目地址去重验证**：
  - 验证同管家同地址的去重逻辑
  - 检查地址标准化处理
  - 确认去重后的数据一致性
- [ ] **自引单奖励验证**：
  - 验证自引单奖励的触发条件
  - 检查自引单奖励金额计算
  - 确认奖励与其他奖励的组合逻辑
- [ ] **管家键格式验证**：
  - 验证"管家_服务商"格式的正确性
  - 检查管家键的唯一性
  - 确认基于管家键的累计统计

### 第5步：差异分析和修复（预计时间待定）
- [ ] **双轨统计差异分析**：
  - 平台单/自引单分类差异
  - 累计统计差异
  - 地址去重差异
- [ ] **根因分析**：
  - tradeIn字段处理问题
  - 项目地址标准化问题
  - 管家键生成问题
- [ ] **修复实施**：
  - 修复双轨统计逻辑
  - 修复地址去重算法
  - 修复自引单奖励计算
- [ ] **修复验证**：
  - 从第1步重新开始完整流程
  - 确认修复效果

### 第6步：最终确认（预计1小时）
- [ ] **完整端到端重测**：
  - 清空数据库，重新执行完整流程
  - 确保修复后的双轨统计完全正确
- [ ] **零差异确认**：
  - 所有双轨统计字段100%一致
  - 项目地址去重结果一致
  - 自引单奖励计算结果一致
- [ ] **双轨统计完整性确认**：
  - 平台单+自引单=总计
  - 分轨道累计统计正确
  - 管家键格式统一
- [ ] **文档和报告**：
  - 生成双轨统计验证报告
  - 记录完整的测试过程
  - 备份所有测试数据和结果

## 📄 交付物

1. **双轨统计验证报告**: 详细的双轨统计验证结果
2. **地址去重分析**: 项目地址去重的详细分析
3. **自引单奖励验证**: 自引单奖励逻辑的验证结果
4. **对比数据**: 新旧系统的双轨统计对比数据

---

**负责人**: Frank & AI Assistant  
**依赖**: 北京9月验证完成  
**计划开始**: 2025-01-10  
**预计完成**: 2025-01-12  
**状态**: 待开始
