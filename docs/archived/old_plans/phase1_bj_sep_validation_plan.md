# 阶段1：北京9月Job详细验证计划

**Job代码**: BJ-SEP-2025  
**Job名称**: 北京9月销售激励  
**验证类型**: 真实数据逐字段验证  
**优先级**: 最高（当前重点）

## 📋 验证目标

### 核心目标
1. **字段完全一致**: 每个字段值与旧系统100%一致
2. **业务逻辑正确**: 所有复杂计算逻辑结果一致
3. **数据完整性**: 无遗漏、无重复、无错误
4. **性能可接受**: 处理时间在合理范围内

### 验证范围
- **数据获取**: Metabase API调用和数据转换
- **业务计算**: 5万上限、累计统计、个人序列等
- **奖励逻辑**: 各类奖励的触发和计算
- **输出格式**: CSV文件格式和内容
- **通知逻辑**: 通知内容和发送对象

## 🔍 详细验证检查点

### 1. 基础字段验证
每个合同记录必须验证的字段：

#### 1.1 标识字段
- [ ] **合同ID(_id)**: 唯一标识，必须完全匹配
- [ ] **活动编号**: 必须为"BJ-SEP"
- [ ] **工单编号(serviceAppointmentNum)**: 工单标识

#### 1.2 主体信息字段
- [ ] **管家(serviceHousekeeper)**: 管家姓名
- [ ] **服务商(orgName)**: 服务商名称
- [ ] **合同编号(contractdocNum)**: 合同编号

#### 1.3 金额字段（精确验证）
- [ ] **合同金额(adjustRefundMoney)**: 原始合同金额
- [ ] **支付金额(paidAmount)**: 实际支付金额
- [ ] **计入业绩金额**: 最终计入业绩的金额（关键字段）
- [ ] **差额(difference)**: 合同金额与支付金额差额

#### 1.4 时间字段
- [ ] **创建时间(createTime)**: 合同创建时间
- [ ] **签约时间(signedDate)**: 合同签约时间

#### 1.5 统计字段
- [ ] **活动期内第几个合同**: 个人序列号（幸运数字基础）
- [ ] **管家累计单数**: 管家在活动期内累计合同数
- [ ] **管家累计金额**: 管家在活动期内累计业绩金额

#### 1.6 奖励字段
- [ ] **奖励类型**: 获得的奖励类型列表
- [ ] **奖励名称**: 获得的奖励名称列表
- [ ] **激活奖励状态**: 是否激活奖励（0/1）

### 2. 北京特有业务逻辑验证

#### 2.1 历史合同处理逻辑
- [ ] **pcContractdocNum字段**: 历史合同编号处理
- [ ] **历史合同标识**: is_historical字段正确性
- [ ] **历史合同业绩**: 历史合同的业绩计算逻辑

#### 2.2 5万上限逻辑
- [ ] **单个工单上限**: 每个工单最多计入5万业绩
- [ ] **超限处理**: 超过5万的工单正确截断到5万
- [ ] **累计影响**: 5万上限对累计统计的影响

#### 2.3 个人序列幸运数字
- [ ] **序列计算**: 活动期内个人合同序列号
- [ ] **幸运数字逻辑**: 特定序列号的奖励触发
- [ ] **跨工单统计**: 多个工单的序列连续性

#### 2.4 管家键格式
- [ ] **键格式**: 使用"管家"格式（北京特有）
- [ ] **累计统计**: 基于管家键的正确累计
- [ ] **去重逻辑**: 基于管家键的去重处理

### 3. 奖励计算验证

#### 3.1 基础奖励
- [ ] **达标奖**: 达到基础门槛的奖励
- [ ] **优秀奖**: 达到优秀门槛的奖励
- [ ] **精英奖**: 达到精英门槛的奖励

#### 3.2 特殊奖励
- [ ] **接好运**: 幸运数字奖励
- [ ] **奖励倍数**: 精英称号的奖励倍数

#### 3.3 奖励触发逻辑
- [ ] **门槛计算**: 各级奖励门槛的正确计算
- [ ] **累计基础**: 基于累计业绩的奖励判断
- [ ] **奖励组合**: 多个奖励的正确组合

## 📊 验证方法和工具

### 验证工具
1. **detailed_field_validator.py**: 逐字段对比工具
2. **business_logic_checker.py**: 业务逻辑专项检查
3. **performance_comparator.py**: 性能对比工具

### 验证数据
1. **基准数据**: 旧系统生成的标准输出
2. **测试数据**: 新系统生成的输出
3. **API数据**: 直接从Metabase获取的原始数据

### 验证步骤
1. **环境准备**: 确保API连接正常
2. **基准获取**: 运行旧系统获取基准数据
3. **新系统执行**: 运行新架构生成测试数据
4. **逐字段对比**: 使用验证工具进行详细对比
5. **差异分析**: 分析所有发现的差异
6. **问题修复**: 修复发现的问题
7. **重新验证**: 确认修复后的一致性

## 📈 成功标准

### 数据一致性标准
- **关键字段**: 100%一致（合同ID、金额、奖励等）
- **统计字段**: 99.9%以上一致
- **文本字段**: 100%一致（去除空格后）
- **数值字段**: 精确到分（0.01元）

### 业务逻辑标准
- **5万上限**: 100%正确实施
- **累计统计**: 100%准确
- **奖励计算**: 100%正确
- **个人序列**: 100%准确

### 性能标准
- **处理时间**: 不超过旧系统1.5倍
- **内存使用**: 合理范围内
- **API调用**: 稳定无超时

## 🚨 风险点和注意事项

### 高风险点
1. **金额计算**: 精度问题可能导致差异
2. **时间处理**: 时区和格式可能不一致
3. **累计统计**: 复杂的跨记录计算逻辑
4. **奖励逻辑**: 多层嵌套的判断条件

### 注意事项
1. **数据顺序**: CSV文件中记录的顺序可能不同
2. **空值处理**: 空值、None、空字符串的统一处理
3. **字符编码**: 确保UTF-8编码一致
4. **浮点精度**: 使用Decimal进行精确计算

## 📋 执行计划（端到端测试流程）

### 第1步：环境初始化（预计1小时）
- [ ] **清空新系统数据库**：
  ```sql
  DELETE FROM performance_records WHERE activity_code = 'BJ-SEP';
  DELETE FROM notification_queue WHERE activity_code = 'BJ-SEP';
  ```
- [ ] **验证数据库状态**：确认相关表为空
- [ ] **API连接测试**：确认Metabase API正常响应
- [ ] **配置文件检查**：验证API_URL_BJ_SEP等配置
- [ ] **日志环境准备**：清理或备份旧日志文件

### 第2步：获取基准数据（预计2小时）
- [ ] **准备旧系统环境**：
  - 清空旧系统数据库（如果使用）
  - 确保使用相同的API数据源
- [ ] **执行旧系统完整流程**：
  - 运行旧系统的BJ-SEP Job
  - 记录执行时间和处理记录数
- [ ] **收集基准输出**：
  - 保存生成的CSV文件为baseline
  - 记录数据库状态（如果适用）
  - 记录应该发送的通知内容
- [ ] **基准数据验证**：
  - 检查CSV文件格式和完整性
  - 验证关键字段的合理性
  - 备份基准数据到专用目录

### 第3步：执行新系统（预计1小时）
- [ ] **再次确认环境干净**：
  - 验证新系统数据库为空
  - 确认无残留的临时文件
- [ ] **执行新架构完整流程**：
  - 运行 `signing_and_sales_incentive_sep_beijing_v2()`
  - 记录执行时间和处理记录数
  - 监控执行过程中的日志
- [ ] **收集测试输出**：
  - 保存生成的CSV文件
  - 导出数据库中的performance_records
  - 导出notification_queue中的通知记录
- [ ] **执行状态检查**：
  - 确认无异常和错误
  - 验证输出文件格式正确

### 第4步：数据对比验证（预计4小时）
- [ ] **文件级初步对比**：
  - 比较CSV文件行数
  - 比较文件大小和格式
- [ ] **字段级详细对比**：
  ```bash
  python scripts/detailed_field_validator.py \
    --job BJ-SEP \
    --baseline baseline/performance_data_BJ-SEP_baseline.csv \
    --current performance_data_BJ-SEP_*.csv \
    --output reports/bj_sep_field_validation.md
  ```
- [ ] **数据库状态对比**：
  - 对比performance_records表内容
  - 验证数据库记录与CSV一致性
- [ ] **业务逻辑专项验证**：
  - 5万上限逻辑验证
  - 累计统计逻辑验证
  - 个人序列计算验证
  - 奖励计算逻辑验证
- [ ] **通知内容对比**：
  - 对比通知队列内容
  - 验证通知发送对象正确性

### 第5步：差异分析和修复（预计时间待定）
- [ ] **差异分类和优先级**：
  - 关键字段差异（最高优先级）
  - 业务逻辑差异（高优先级）
  - 格式差异（中优先级）
  - 性能差异（低优先级）
- [ ] **根因分析**：
  - 分析每个差异的具体原因
  - 确定是数据问题、逻辑问题还是配置问题
- [ ] **修复实施**：
  - 修复发现的代码问题
  - 更新配置或数据处理逻辑
- [ ] **修复验证**：
  - 从第1步重新开始完整流程
  - 确认修复效果

### 第6步：最终确认（预计1小时）
- [ ] **完整端到端重测**：
  - 清空数据库，重新执行完整流程
  - 确保修复后的系统完全正确
- [ ] **零差异确认**：
  - 所有关键字段100%一致
  - 所有业务逻辑结果一致
  - 通知内容完全匹配
- [ ] **性能基准确认**：
  - 处理时间在可接受范围内
  - 资源消耗合理
- [ ] **文档和报告**：
  - 生成最终验证报告
  - 记录完整的测试过程
  - 备份所有测试数据和结果

## 📄 交付物

1. **验证报告**: 详细的字段对比结果
2. **差异清单**: 所有发现的差异及解决方案
3. **测试数据**: 基准数据和测试数据
4. **修复记录**: 问题修复的详细记录

---

**负责人**: Frank & AI Assistant  
**计划开始**: 2025-01-08  
**预计完成**: 2025-01-10  
**状态**: 准备中
