# 北京与上海业务对比文档

## 1. 数据源对比

| 项目 | 北京 | 上海 |
|------|------|------|
| **API端点** | `/api/card/1864/query` | `/api/card/1838/query` |
| **管家标识格式** | `管家` | `管家_服务商` |
| **数据字段数量** | 23个字段 | 22个字段 |
| **特殊字段** | `pcContractdocNum`（历史合同编号） | 无 |

### 共同数据字段
- 合同ID、活动城市、工单编号、管家、服务商
- 合同金额、支付金额、差额、状态、创建时间
- 签约时间、款项来源类型、工单类型、项目地址等

## 2. 9月活动规则对比

| 规则项目 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **幸运数字** | 5（个人序号倍数） | 无 |
| **合同门槛** | 10个合同 | 5个合同 |
| **工单金额上限** | 5万元 | 无上限 |
| **合同金额上限** | 5万元 | 无上限 |
| **双轨统计** | 不支持 | 支持（平台单/自引单） |
| **历史合同** | 支持 | 不支持 |

### 奖励对比

| 奖励类型 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **幸运奖** | 接好运 58元 | 无 |
| **基础奖** | 无 | 4万业绩 200元 |
| **达标奖** | 8万业绩 400元 | 6万业绩 300元 |
| **优秀奖** | 18万业绩 800元 | 8万业绩 400元 |
| **精英奖** | 28万业绩 1600元 | 12万业绩 800元 |
| **卓越奖** | 无 | 16万业绩 1200元 |
| **自引单奖** | 无 | 红包 50元 |

## 3. 新架构技术实现对比

| 技术项目 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **配置键** | `BJ-2025-09` | `SH-2025-09` |
| **活动编码** | `BJ-SEP` | `SH-SEP` |
| **管家格式** | `管家` | `管家_服务商` |
| **工单金额上限** | 启用（5万） | 禁用 |
| **合同金额上限** | 启用（5万） | 禁用 |
| **双轨统计** | 禁用 | 启用 |
| **历史合同** | 启用 | 禁用 |
| **CSV输出** | 禁用 | 禁用 |

### 处理管道配置

| 配置项 | 北京9月 | 上海9月 |
|--------|---------|---------|
| **存储类型** | SQLite | SQLite |
| **幸运数字模式** | 个人序号 | 无 |
| **项目地址去重** | 禁用 | 启用（仅自引单） |
| **奖励历史检查** | 启用 | 启用 |

### 关键差异说明

1. **北京特色**：支持历史合同处理，启用工单/合同金额上限，使用个人序号幸运数字
2. **上海特色**：支持双轨统计（平台单/自引单），无金额限制，项目地址去重，奖励层级更多
3. **共同特性**：使用SQLite存储，支持奖励历史检查

## 4. 消息生成与通知系统对比

### 4.1 群通知消息格式

#### 北京9月群通知完整模板
```
🧨🧨🧨 签约喜报 🧨🧨🧨
恭喜 {管家名称} 签约合同 {合同编号} 并完成线上收款🎉🎉🎉

🌻 本单为活动期间平台累计签约第 {全局序号} 单，个人累计签约第 {个人序号} 单。

🌻 {管家名称}累计签约 {累计金额} 元, 累计计入业绩 {累计业绩} 元

👊 {备注信息}。
```

#### 上海9月群通知完整模板
```
🧨🧨🧨 签约喜报 🧨🧨🧨

恭喜 {管家名称} 签约合同（{订单类型}） {合同编号} 并完成线上收款🎉🎉🎉

🌻 本单为本月平台累计签约第 {全局序号} 单，

🌻 个人平台单累计签约第 {平台单数} 单， 自引单累计签约第 {自引单数} 单。
🌻 个人平台单金额累计签约 {平台单金额} 元，自引单金额累计签约 {自引单金额}元

🌻 个人平台单转化率 {转化率}，

👊 {备注信息} 🎉🎉🎉。
```

### 4.2 群通知取数逻辑对比

| 数据字段 | 北京9月取数逻辑 | 上海9月取数逻辑 |
|----------|----------------|----------------|
| **管家名称** | `record["管家(serviceHousekeeper)"]`<br>+ 徽章逻辑（精英管家添加徽章） | `record["管家(serviceHousekeeper)"]`<br>（无徽章逻辑） |
| **合同编号** | `record["合同编号(contractdocNum)"]` | `record["合同编号(contractdocNum)"]` |
| **订单类型** | 不显示（仅平台单） | `record.get("工单类型", "平台单")`<br>显示为`（平台单）`或`（自引单）` |
| **全局序号** | `record["活动期内第几个合同"]` | `record["活动期内第几个合同"]` |
| **个人序号** | `record["管家累计单数"]` | 不显示单一个人序号 |
| **平台单数** | 不区分 | `record.get("平台单累计数量", 0)` |
| **自引单数** | 不区分 | `record.get("自引单累计数量", 0)` |
| **累计金额** | `preprocess_amount(record["管家累计金额"])` | 分别显示平台单和自引单金额 |
| **累计业绩** | `preprocess_amount(record["管家累计业绩金额"])`<br>（仅在启用业绩上限时显示） | 不显示业绩概念 |
| **转化率** | 不显示 | `preprocess_rate(record["转化率(conversion)"])` |
| **备注信息** | 动态生成：<br>- `"无"` → `"恭喜已经达成所有奖励，祝愿再接再厉，再创佳绩 🎉🎉🎉"`<br>- 其他 → 直接显示备注内容 | 根据订单类型：<br>- 自引单 → `"继续加油，争取更多奖励"`<br>- 平台单 → 同北京逻辑 |

### 4.3 个人奖励通知格式与逻辑

#### 奖励消息生成逻辑

**核心函数**: `generate_award_message(record, awards_mapping, city, config_key)`

| 处理步骤 | 北京9月逻辑 | 上海9月逻辑 |
|----------|-------------|-------------|
| **徽章处理** | 检查是否为精英管家<br>`if service_housekeeper in ELITE_HOUSEKEEPER:`<br>添加徽章：`f'{ELITE_BADGE_NAME}{service_housekeeper}'` | 不处理徽章<br>直接使用原始管家名 |
| **奖励解析** | 解析 `record["奖励名称"].split(', ')` | 同北京 |
| **奖励翻倍** | 精英管家的"节节高"奖励翻倍<br>`if reward_type == "节节高":`<br>`award_info_double = str(int(award_info) * 2)` | 无翻倍逻辑 |
| **消息格式** | 翻倍：`达成 {奖励名} 奖励条件，奖励金额 {原金额} 元，同时触发"精英连击双倍奖励"，奖励金额🚀直升至 {翻倍金额} 元！🧧🧧🧧`<br>普通：`达成{奖励名}奖励条件，获得签约奖励{金额}元 🧧🧧🧧` | 统一格式：`达成{奖励名}奖励条件，获得签约奖励{金额}元 🧧🧧🧧` |

#### 奖励金额配置对比

| 奖励类型 | 北京9月金额 | 上海9月金额 | 备注 |
|----------|-------------|-------------|------|
| **接好运** | 58元 | 不支持 | 北京幸运数字奖励 |
| **基础奖** | 不支持 | 200元 | 上海4万业绩奖励 |
| **达标奖** | 400元 | 300元 | 北京8万，上海6万业绩 |
| **优秀奖** | 800元 | 400元 | 北京18万，上海8万业绩 |
| **精英奖** | 1600元 | 800元 | 北京28万，上海12万业绩 |
| **卓越奖** | 不支持 | 1200元 | 上海16万业绩奖励 |
| **红包** | 不支持 | 50元 | 上海自引单奖励 |

#### 实际消息示例

**北京9月普通管家奖励消息**：
```
达成接好运奖励条件，获得签约奖励58元 🧧🧧🧧
达成达标奖奖励条件，获得签约奖励400元 🧧🧧🧧
```

**北京9月精英管家翻倍奖励消息**：
```
达成 达标奖 奖励条件，奖励金额 400 元，同时触发"精英连击双倍奖励"，奖励金额🚀直升至 800 元！🧧🧧🧧
```

**上海9月奖励消息**：
```
达成基础奖奖励条件，获得签约奖励200元 🧧🧧🧧
达成红包奖励条件，获得签约奖励50元 🧧🧧🧧
```

### 4.4 备注字段生成逻辑详解

#### 备注字段核心逻辑

**生成位置**: `RecordBuilder._build_remarks()` 方法

| 合同类型 | 北京9月逻辑 | 上海9月逻辑 |
|----------|-------------|-------------|
| **历史合同** | `if contract_data.is_historical:`<br>`return "历史合同-仅计入业绩金额"` | 不支持历史合同<br>`is_historical` 始终为 `False` |
| **普通合同** | `return next_reward_gap if next_reward_gap else "无"` | 同北京逻辑 |

#### next_reward_gap 生成逻辑

**生成位置**: `RewardCalculator.calculate_rewards()` 方法

```python
# 计算下一级奖励差距
if current_performance < next_threshold:
    gap_amount = next_threshold - current_performance
    next_reward_gap = f"距离达成{next_reward_name}还需 {gap_amount/10000:.0f} 万元"
else:
    next_reward_gap = "无"  # 已达最高级或无更高奖励
```

#### 实际备注示例

| 业绩情况 | 北京9月备注 | 上海9月备注 |
|----------|-------------|-------------|
| **0元业绩** | `距离达成达标奖还需 8 万元` | `距离达成基础奖还需 4 万元` |
| **5万业绩** | `距离达成达标奖还需 3 万元` | `距离达成达标奖还需 1 万元` |
| **10万业绩** | `距离达成优秀奖还需 8 万元` | `距离达成优秀奖还需 -2 万元`<br>（实际显示为已达成） |
| **30万业绩** | `无`（已达最高精英奖） | `距离达成卓越奖还需 -14 万元`<br>（实际显示为已达成） |
| **历史合同** | `历史合同-仅计入业绩金额` | 不适用 |

#### 特殊处理逻辑

| 场景 | 处理方式 | 代码逻辑 |
|------|----------|----------|
| **已达最高奖励** | 显示"无" | `next_reward_gap = "无"` |
| **负数差距** | 显示"无" | 计算逻辑确保不会出现负数 |
| **历史合同** | 固定文本 | 优先级最高，直接返回固定文本 |
| **无奖励配置** | 显示"无" | 默认值处理 |

### 4.5 消息生成技术实现对比

#### 核心函数调用链

| 处理阶段 | 北京9月调用链 | 上海9月调用链 |
|----------|---------------|---------------|
| **群通知** | `notify_awards_beijing_generic()` → `create_task('send_wecom_message', WECOM_GROUP_NAME_BJ, msg)` | `notify_awards_shanghai_generic()` → `create_task('send_wecom_message', WECOM_GROUP_NAME_SH, msg)` |
| **奖励通知** | `generate_award_message(record, awards_mapping, "BJ", config_key)` → `create_task('send_wechat_message', CAMPAIGN_CONTACT_BJ, jiangli_msg)` | `generate_award_message(record, awards_mapping, "SH", config_key)` → `create_task('send_wechat_message', CAMPAIGN_CONTACT_SH, jiangli_msg)` |

#### 配置驱动的消息生成

| 配置项 | 北京9月配置 | 上海9月配置 | 影响范围 |
|--------|-------------|-------------|----------|
| **config_key** | `"BJ-2025-09"` | `"SH-2025-09"` | 奖励金额映射 |
| **awards_mapping** | `{"接好运": "58", "达标奖": "400", "优秀奖": "800", "精英奖": "1600"}` | `{"基础奖": "200", "达标奖": "300", "优秀奖": "400", "精英奖": "800", "卓越奖": "1200", "红包": "50"}` | 奖励消息金额 |
| **群名称** | `WECOM_GROUP_NAME_BJ = '北京运营中心系统通知群'` | `WECOM_GROUP_NAME_SH = '（上海）运营群'` | 群通知目标 |
| **联系人** | `CAMPAIGN_CONTACT_BJ = '王爽'` | `CAMPAIGN_CONTACT_SH = '满浩浩'` | 个人通知目标 |

#### 数据预处理函数

| 函数名 | 用途 | 北京使用 | 上海使用 |
|--------|------|----------|----------|
| `preprocess_amount()` | 格式化金额显示（添加千分位分隔符） | ✅ 累计金额、业绩金额 | ✅ 平台单金额、自引单金额 |
| `preprocess_rate()` | 格式化转化率显示 | ❌ 不显示转化率 | ✅ 平台单转化率 |
| `should_enable_badge()` | 检查是否启用徽章功能 | ✅ 精英管家徽章 | ❌ 无徽章功能 |

#### 消息发送任务创建

**任务类型对比**：
- **群通知任务**: `create_task('send_wecom_message', 群名称, 消息内容)`
- **个人通知任务**: `create_task('send_wechat_message', 联系人, 消息内容)`

**发送状态管理**：
```python
# 统一的状态管理逻辑
update_send_status(status_filename, contract_id, '发送成功')
record['是否发送通知'] = 'Y'
```

## 5. 数据处理流程差异

| 处理步骤 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **数据获取** | Metabase API（23字段） | Metabase API（22字段） |
| **历史合同** | 获取并处理 | 跳过 |
| **金额上限** | 工单/合同5万上限 | 不限制 |
| **订单分类** | 仅平台单 | 平台单+自引单 |
| **项目地址去重** | 不处理 | 自引单去重 |
| **奖励计算** | 单轨+幸运数字 | 双轨+自引单奖励 |
| **消息生成** | 标准格式+历史合同标识 | 双轨格式+订单类型标识 |
| **输出格式** | 标准CSV | 双轨CSV |

## 6. 核心业务差异深度分析

### 6.1 奖励机制差异

| 差异维度 | 北京9月 | 上海9月 | 影响分析 |
|----------|---------|---------|----------|
| **奖励触发** | 业绩累计 + 幸运数字 | 业绩累计 + 订单类型 | 北京更注重运气因素，上海更注重业务分类 |
| **奖励层级** | 4层（接好运→达标→优秀→精英） | 6层（基础→达标→优秀→精英→卓越+自引单） | 上海奖励体系更精细，激励更全面 |
| **最高奖励** | 精英奖 1600元（28万业绩） | 卓越奖 1200元（16万业绩） | 北京单笔更高，上海门槛更低 |
| **特殊奖励** | 幸运奖（序号倍数） | 自引单奖（每单50元） | 北京偶发性，上海持续性 |

### 6.2 业务规则复杂度

| 复杂度项目 | 北京9月 | 上海9月 | 技术实现难度 |
|------------|---------|---------|--------------|
| **历史合同处理** | ✅ 支持 | ❌ 不支持 | 中等（需要特殊标识和处理逻辑） |
| **金额上限控制** | ✅ 工单+合同双重上限 | ❌ 无限制 | 高（需要项目维度累计计算） |
| **双轨统计** | ❌ 单轨 | ✅ 平台单+自引单 | 高（需要订单分类和独立统计） |
| **项目地址去重** | ❌ 不处理 | ✅ 自引单去重 | 中等（需要内存去重逻辑） |
| **幸运数字** | ✅ 个人序号倍数 | ❌ 无 | 低（简单数学计算） |

### 6.3 数据一致性要求

| 一致性维度 | 北京9月 | 上海9月 | 关键挑战 |
|------------|---------|---------|----------|
| **管家标识** | 单一管家名 | 管家_服务商组合 | 上海需要处理管家跨服务商情况 |
| **业绩计算** | 单轨累计 | 双轨独立累计 | 上海需要维护两套统计数据 |
| **奖励发放** | 基于总业绩 | 基于分轨业绩+订单类型 | 上海逻辑更复杂，容错性要求更高 |
| **历史数据** | 需要补录处理 | 仅处理当期 | 北京需要额外的数据清洗和标识 |

## 7. 技术架构差异

### 7.1 新架构统一设计优势

| 统一特性 | 实现方式 | 业务适配 |
|----------|----------|----------|
| **配置驱动** | `ProcessingConfig` 类 | 通过配置开关适配不同城市规则 |
| **模块化设计** | 独立的计算器、构建器、存储层 | 各城市共享核心逻辑，差异化配置 |
| **数据库统一** | SQLite + 统一Schema | 支持多城市数据存储和查询 |
| **通知服务** | `NotificationService` 类 | 统一消息生成，支持城市特色格式 |

### 7.2 城市特化实现

| 特化项目 | 北京实现 | 上海实现 | 代码复用度 |
|----------|----------|----------|------------|
| **奖励计算** | `BJ_SEP_2024` 配置 | `SH_SEP_2024` 配置 | 95%（仅配置差异） |
| **消息生成** | 历史合同标识 | 双轨订单标识 | 90%（模板复用） |
| **数据处理** | 金额上限逻辑 | 双轨统计逻辑 | 85%（核心流程相同） |
| **存储结构** | 统一Schema | 统一Schema | 100%（完全复用） |

### 7.3 维护成本分析

| 维护项目 | 传统方式 | 新架构方式 | 效率提升 |
|----------|----------|------------|----------|
| **新增城市** | 复制整套代码 | 添加配置文件 | 80% |
| **规则调整** | 修改多处硬编码 | 修改配置参数 | 70% |
| **Bug修复** | 多套代码同步修复 | 单点修复全局生效 | 90% |
| **功能测试** | 每个城市独立测试 | 配置驱动批量测试 | 60% |

## 8. 性能与扩展性对比

### 8.1 处理性能

| 性能指标 | 北京9月 | 上海9月 | 优化建议 |
|----------|---------|---------|----------|
| **数据量** | ~200-300条/月 | ~400-500条/月 | 当前架构足够支撑 |
| **处理时间** | <5秒 | <8秒 | 双轨统计增加计算复杂度 |
| **内存使用** | 低（单轨） | 中等（双轨+去重） | 可考虑流式处理优化 |
| **数据库查询** | 简单查询 | 复杂查询（分组统计） | 已优化索引结构 |

### 8.2 扩展性评估

| 扩展维度 | 当前支持度 | 扩展难度 | 建议方案 |
|----------|------------|----------|----------|
| **新增奖励类型** | ✅ 高 | 低 | 配置文件添加即可 |
| **新增城市规则** | ✅ 高 | 低 | 复制配置模板调整 |
| **复杂业务逻辑** | ✅ 中等 | 中等 | 插件化扩展机制 |
| **大数据量处理** | ⚠️ 待验证 | 高 | 分批处理+异步队列 |

---

*文档生成时间：2025-01-24*
*对应代码版本：production-db-v2分支*
*新架构版本：v1.1.0（支持通知服务）*
