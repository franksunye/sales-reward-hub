# 北京与上海业务对比文档

## 1. 数据源对比

| 项目 | 北京 | 上海 |
|------|------|------|
| **API端点** | `/api/card/1864/query` | `/api/card/1838/query` |
| **管家标识格式** | `管家` | `管家_服务商` |
| **数据字段数量** | 23个字段 | 22个字段 |
| **特殊字段** | `pcContractdocNum`（历史合同编号） | 无 |

### 共同数据字段
- 合同ID、活动城市、工单编号、管家、服务商
- 合同金额、支付金额、差额、状态、创建时间
- 签约时间、款项来源类型、工单类型、项目地址等

## 2. 9月活动规则对比

| 规则项目 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **幸运数字** | 5（个人序号倍数） | 无 |
| **合同门槛** | 10个合同 | 5个合同 |
| **工单金额上限** | 5万元 | 无上限 |
| **合同金额上限** | 5万元 | 无上限 |
| **双轨统计** | 不支持 | 支持（平台单/自引单） |
| **历史合同** | 支持 | 不支持 |

### 奖励对比

| 奖励类型 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **幸运奖** | 接好运 58元 | 无 |
| **基础奖** | 无 | 4万业绩 200元 |
| **达标奖** | 8万业绩 400元 | 6万业绩 300元 |
| **优秀奖** | 18万业绩 800元 | 8万业绩 400元 |
| **精英奖** | 28万业绩 1600元 | 12万业绩 800元 |
| **卓越奖** | 无 | 16万业绩 1200元 |
| **自引单奖** | 无 | 红包 50元 |

## 3. 新架构技术实现对比

| 技术项目 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **配置键** | `BJ-2025-09` | `SH-2025-09` |
| **活动编码** | `BJ-SEP` | `SH-SEP` |
| **管家格式** | `管家` | `管家_服务商` |
| **工单金额上限** | 启用（5万） | 禁用 |
| **合同金额上限** | 启用（5万） | 禁用 |
| **双轨统计** | 禁用 | 启用 |
| **历史合同** | 启用 | 禁用 |
| **CSV输出** | 禁用 | 禁用 |

### 处理管道配置

| 配置项 | 北京9月 | 上海9月 |
|--------|---------|---------|
| **存储类型** | SQLite | SQLite |
| **幸运数字模式** | 个人序号 | 无 |
| **项目地址去重** | 禁用 | 启用（仅自引单） |
| **奖励历史检查** | 启用 | 启用 |

### 关键差异说明

1. **北京特色**：支持历史合同处理，启用工单/合同金额上限，使用个人序号幸运数字
2. **上海特色**：支持双轨统计（平台单/自引单），无金额限制，项目地址去重，奖励层级更多
3. **共同特性**：使用SQLite存储，支持奖励历史检查

## 4. 消息生成与通知系统对比

### 4.1 群通知消息格式

| 消息类型 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **基础格式** | `🎉 恭喜 {管家} 获得奖励！` | `🎉 恭喜 {管家} 获得奖励！` |
| **奖励显示** | 单个奖励：`接好运 58元`<br>多个奖励：`接好运 58元, 达标奖 400元` | 单个奖励：`基础奖 200元`<br>多个奖励：`基础奖 200元, 达标奖 300元` |
| **业绩信息** | `当前业绩：{累计金额}元` | `当前业绩：{累计金额}元` |
| **特殊标识** | 历史合同：`（历史合同补录）` | 双轨标识：`（平台单）`或`（自引单）` |

#### 北京群通知示例
```
🎉 恭喜 张三 获得奖励！
奖励：接好运 58元
当前业绩：15000元
（第5单幸运奖励）
```

#### 上海群通知示例
```
🎉 恭喜 李四 获得奖励！
奖励：基础奖 200元, 自引单奖 50元
当前业绩：45000元
（自引单）
```

### 4.2 个人奖励通知格式

| 通知内容 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **标题** | `🎊 恭喜获得激励奖励！` | `🎊 恭喜获得激励奖励！` |
| **奖励详情** | `接好运：58元`<br>`达标奖：400元` | `基础奖：200元`<br>`自引单奖：50元` |
| **业绩进度** | `当前业绩：80000元`<br>`距离优秀奖还需：100000元` | `当前业绩：45000元`<br>`距离达标奖还需：15000元` |
| **特殊说明** | 幸运数字：`恭喜您是第5单！` | 双轨说明：`自引单额外奖励` |

### 4.3 备注字段生成逻辑

| 合同类型 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **历史合同** | `历史合同-仅计入业绩金额` | 不支持历史合同 |
| **普通合同** | `距离达成优秀奖还需 10 万元` | `距离达成达标奖还需 1.5 万元` |
| **无奖励差距** | `无` | `无` |
| **已达最高级** | `已达成最高奖励` | `已达成最高奖励` |

## 5. 数据处理流程差异

| 处理步骤 | 北京9月 | 上海9月 |
|----------|---------|---------|
| **数据获取** | Metabase API（23字段） | Metabase API（22字段） |
| **历史合同** | 获取并处理 | 跳过 |
| **金额上限** | 工单/合同5万上限 | 不限制 |
| **订单分类** | 仅平台单 | 平台单+自引单 |
| **项目地址去重** | 不处理 | 自引单去重 |
| **奖励计算** | 单轨+幸运数字 | 双轨+自引单奖励 |
| **消息生成** | 标准格式+历史合同标识 | 双轨格式+订单类型标识 |
| **输出格式** | 标准CSV | 双轨CSV |

## 6. 核心业务差异深度分析

### 6.1 奖励机制差异

| 差异维度 | 北京9月 | 上海9月 | 影响分析 |
|----------|---------|---------|----------|
| **奖励触发** | 业绩累计 + 幸运数字 | 业绩累计 + 订单类型 | 北京更注重运气因素，上海更注重业务分类 |
| **奖励层级** | 4层（接好运→达标→优秀→精英） | 6层（基础→达标→优秀→精英→卓越+自引单） | 上海奖励体系更精细，激励更全面 |
| **最高奖励** | 精英奖 1600元（28万业绩） | 卓越奖 1200元（16万业绩） | 北京单笔更高，上海门槛更低 |
| **特殊奖励** | 幸运奖（序号倍数） | 自引单奖（每单50元） | 北京偶发性，上海持续性 |

### 6.2 业务规则复杂度

| 复杂度项目 | 北京9月 | 上海9月 | 技术实现难度 |
|------------|---------|---------|--------------|
| **历史合同处理** | ✅ 支持 | ❌ 不支持 | 中等（需要特殊标识和处理逻辑） |
| **金额上限控制** | ✅ 工单+合同双重上限 | ❌ 无限制 | 高（需要项目维度累计计算） |
| **双轨统计** | ❌ 单轨 | ✅ 平台单+自引单 | 高（需要订单分类和独立统计） |
| **项目地址去重** | ❌ 不处理 | ✅ 自引单去重 | 中等（需要内存去重逻辑） |
| **幸运数字** | ✅ 个人序号倍数 | ❌ 无 | 低（简单数学计算） |

### 6.3 数据一致性要求

| 一致性维度 | 北京9月 | 上海9月 | 关键挑战 |
|------------|---------|---------|----------|
| **管家标识** | 单一管家名 | 管家_服务商组合 | 上海需要处理管家跨服务商情况 |
| **业绩计算** | 单轨累计 | 双轨独立累计 | 上海需要维护两套统计数据 |
| **奖励发放** | 基于总业绩 | 基于分轨业绩+订单类型 | 上海逻辑更复杂，容错性要求更高 |
| **历史数据** | 需要补录处理 | 仅处理当期 | 北京需要额外的数据清洗和标识 |

## 7. 技术架构差异

### 7.1 新架构统一设计优势

| 统一特性 | 实现方式 | 业务适配 |
|----------|----------|----------|
| **配置驱动** | `ProcessingConfig` 类 | 通过配置开关适配不同城市规则 |
| **模块化设计** | 独立的计算器、构建器、存储层 | 各城市共享核心逻辑，差异化配置 |
| **数据库统一** | SQLite + 统一Schema | 支持多城市数据存储和查询 |
| **通知服务** | `NotificationService` 类 | 统一消息生成，支持城市特色格式 |

### 7.2 城市特化实现

| 特化项目 | 北京实现 | 上海实现 | 代码复用度 |
|----------|----------|----------|------------|
| **奖励计算** | `BJ_SEP_2024` 配置 | `SH_SEP_2024` 配置 | 95%（仅配置差异） |
| **消息生成** | 历史合同标识 | 双轨订单标识 | 90%（模板复用） |
| **数据处理** | 金额上限逻辑 | 双轨统计逻辑 | 85%（核心流程相同） |
| **存储结构** | 统一Schema | 统一Schema | 100%（完全复用） |

### 7.3 维护成本分析

| 维护项目 | 传统方式 | 新架构方式 | 效率提升 |
|----------|----------|------------|----------|
| **新增城市** | 复制整套代码 | 添加配置文件 | 80% |
| **规则调整** | 修改多处硬编码 | 修改配置参数 | 70% |
| **Bug修复** | 多套代码同步修复 | 单点修复全局生效 | 90% |
| **功能测试** | 每个城市独立测试 | 配置驱动批量测试 | 60% |

## 8. 性能与扩展性对比

### 8.1 处理性能

| 性能指标 | 北京9月 | 上海9月 | 优化建议 |
|----------|---------|---------|----------|
| **数据量** | ~200-300条/月 | ~400-500条/月 | 当前架构足够支撑 |
| **处理时间** | <5秒 | <8秒 | 双轨统计增加计算复杂度 |
| **内存使用** | 低（单轨） | 中等（双轨+去重） | 可考虑流式处理优化 |
| **数据库查询** | 简单查询 | 复杂查询（分组统计） | 已优化索引结构 |

### 8.2 扩展性评估

| 扩展维度 | 当前支持度 | 扩展难度 | 建议方案 |
|----------|------------|----------|----------|
| **新增奖励类型** | ✅ 高 | 低 | 配置文件添加即可 |
| **新增城市规则** | ✅ 高 | 低 | 复制配置模板调整 |
| **复杂业务逻辑** | ✅ 中等 | 中等 | 插件化扩展机制 |
| **大数据量处理** | ⚠️ 待验证 | 高 | 分批处理+异步队列 |

---

*文档生成时间：2025-01-24*
*对应代码版本：production-db-v2分支*
*新架构版本：v1.1.0（支持通知服务）*
