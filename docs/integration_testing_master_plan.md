# 9月份Job集成测试总体规划

**项目**: 9月份Job新架构影子模式部署  
**测试类型**: 真实数据集成测试 (Integration Testing)  
**目标**: 逐步验证新架构与旧系统的完全一致性  

## 📋 测试范围和分解

### 测试任务分解
我们将集成测试分解为以下独立任务，便于控制颗粒度和风险：

#### 阶段1：9月份Job验证 (当前重点)
- [ ] **BJ-SEP-2025**: 北京9月销售激励
- [ ] **SH-SEP-2025**: 上海9月销售激励

#### 阶段2：8月份Job验证 (后续扩展)
- [ ] **BJ-AUG-2025**: 北京8月销售激励  
- [ ] **SH-AUG-2025**: 上海8月销售激励

#### 阶段3：其他Job验证 (可选扩展)
- [ ] **其他活动**: 根据需要添加

## 🎯 测试目标和验证标准

### 核心验证目标
1. **数据完整性**: 每个字段的值必须与旧系统完全一致
2. **业务逻辑正确性**: 复杂计算逻辑结果完全一致
3. **性能可接受性**: 处理速度不低于旧系统
4. **错误处理稳定性**: 异常情况处理正确

### 验证标准
- **字段级验证**: 每个关键字段逐一对比
- **记录级验证**: 每条记录的完整性检查
- **业务级验证**: 复杂业务逻辑结果对比
- **系统级验证**: 整体性能和稳定性

## 📊 数据验证方法论

### 验证层次
1. **API数据获取验证**: 确保从Metabase获取的数据正确
2. **数据转换验证**: 确保字段映射和数据清洗正确
3. **业务逻辑验证**: 确保复杂计算逻辑正确
4. **输出格式验证**: 确保CSV文件格式和内容正确
5. **通知逻辑验证**: 确保通知内容和发送逻辑正确

### 验证粒度
- **合同级**: 每个合同的所有字段
- **管家级**: 每个管家的累计统计
- **活动级**: 整个活动的汇总数据
- **系统级**: 整体处理结果

## 🔍 详细验证检查点

### 通用字段验证
所有Job都需要验证的基础字段：
- [ ] 合同ID(_id)
- [ ] 活动编号
- [ ] 管家(serviceHousekeeper)
- [ ] 服务商(orgName)
- [ ] 合同金额(adjustRefundMoney)
- [ ] 支付金额(paidAmount)
- [ ] 计入业绩金额
- [ ] 创建时间(createTime)
- [ ] 签约时间(signedDate)

### 业务逻辑验证
- [ ] **5万上限逻辑**: 工单金额上限计算
- [ ] **去重逻辑**: 重复合同处理
- [ ] **累计统计**: 管家累计单数和金额
- [ ] **个人序列**: 活动期内序列计算
- [ ] **奖励计算**: 各类奖励的触发和计算

### 特殊业务逻辑验证

#### 北京特有逻辑
- [ ] **历史合同处理**: pcContractdocNum字段处理
- [ ] **管家键格式**: 使用"管家"格式
- [ ] **幸运数字逻辑**: 个人序列幸运数字

#### 上海特有逻辑  
- [ ] **双轨统计**: 平台单/自引单分类
- [ ] **项目地址去重**: 自引单地址去重
- [ ] **管家键格式**: 使用"管家_服务商"格式
- [ ] **自引单奖励**: 自引单特殊奖励逻辑

## 📝 测试执行计划

### 测试环境
- **数据源**: 真实Metabase API
- **对比基准**: 旧系统生成的历史数据
- **测试模式**: 影子模式（不发送消息）
- **验证工具**: 自动化对比脚本

### 执行步骤
1. **环境准备**: 确保API连接和配置正确
2. **基准数据**: 获取旧系统的标准输出
3. **新系统执行**: 运行新架构生成数据
4. **逐字段对比**: 详细对比每个字段
5. **差异分析**: 分析和解决发现的差异
6. **结果确认**: 确认完全一致后通过

## 🛠️ 测试工具和脚本

### 核心测试脚本
- `integration_test_september_jobs.py`: 主要集成测试脚本
- `detailed_field_validator.py`: 详细字段验证工具 (待创建)
- `business_logic_checker.py`: 业务逻辑检查工具 (待创建)
- `performance_comparator.py`: 性能对比工具 (待创建)

### 验证报告
- 每个Job生成独立的验证报告
- 包含详细的字段对比结果
- 记录所有发现的差异和解决方案

## 📈 成功标准

### 通过标准
- **数据一致性**: 99.9%以上字段完全一致
- **业务逻辑**: 100%业务逻辑结果一致
- **性能要求**: 处理时间不超过旧系统1.5倍
- **错误处理**: 无未处理异常

### 风险控制
- 每个Job独立验证，降低风险
- 发现问题立即停止，分析解决
- 保持旧系统作为备份方案
- 渐进式部署，逐步替换

## 📋 当前状态

### 已完成
- [x] 基础架构搭建
- [x] API连接验证
- [x] 初步集成测试
- [x] 环境清理

### 进行中
- [ ] 详细验证工具开发
- [ ] BJ-SEP-2025详细验证
- [ ] SH-SEP-2025详细验证

### 待开始
- [ ] 8月份Job验证
- [ ] 性能基准测试
- [ ] 生产部署准备

## 🎯 下一步行动

1. **创建详细验证工具**: 开发字段级对比工具
2. **获取基准数据**: 收集旧系统的标准输出
3. **执行BJ-SEP验证**: 完整的北京9月验证
4. **执行SH-SEP验证**: 完整的上海9月验证
5. **分析和修复**: 解决发现的任何差异

---

**负责人**: Frank & AI Assistant  
**开始日期**: 2025-01-08  
**预计完成**: 2025-01-15  
**风险等级**: 中等（可控）
