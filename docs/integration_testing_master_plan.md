# 9月份Job集成测试总体规划

**项目**: 9月份Job新架构影子模式部署  
**测试类型**: 真实数据集成测试 (Integration Testing)  
**目标**: 逐步验证新架构与旧系统的完全一致性  

## 📋 测试范围和分解

### 测试任务分解
我们将集成测试分解为以下独立任务，便于控制颗粒度和风险：

#### 阶段1：9月份Job验证 (当前重点)
- [ ] **BJ-SEP-2025**: 北京9月销售激励
- [ ] **SH-SEP-2025**: 上海9月销售激励

#### 阶段2：8月份Job验证 (后续扩展)
- [ ] **BJ-AUG-2025**: 北京8月销售激励  
- [ ] **SH-AUG-2025**: 上海8月销售激励

#### 阶段3：其他Job验证 (可选扩展)
- [ ] **其他活动**: 根据需要添加

## 🎯 测试目标和验证标准

### 核心验证目标
1. **数据完整性**: 每个字段的值必须与旧系统完全一致
2. **业务逻辑正确性**: 复杂计算逻辑结果完全一致
3. **性能可接受性**: 处理速度不低于旧系统
4. **错误处理稳定性**: 异常情况处理正确

### 验证标准
- **字段级验证**: 每个关键字段逐一对比
- **记录级验证**: 每条记录的完整性检查
- **业务级验证**: 复杂业务逻辑结果对比
- **系统级验证**: 整体性能和稳定性

## 📊 数据验证方法论

### 验证层次
1. **API数据获取验证**: 确保从Metabase获取的数据正确
2. **数据转换验证**: 确保字段映射和数据清洗正确
3. **业务逻辑验证**: 确保复杂计算逻辑正确
4. **输出格式验证**: 确保CSV文件格式和内容正确
5. **通知逻辑验证**: 确保通知内容和发送逻辑正确

### 验证粒度
- **合同级**: 每个合同的所有字段
- **管家级**: 每个管家的累计统计
- **活动级**: 整个活动的汇总数据
- **系统级**: 整体处理结果

## 🔍 详细验证检查点

### 通用字段验证
所有Job都需要验证的基础字段：
- [ ] 合同ID(_id)
- [ ] 活动编号
- [ ] 管家(serviceHousekeeper)
- [ ] 服务商(orgName)
- [ ] 合同金额(adjustRefundMoney)
- [ ] 支付金额(paidAmount)
- [ ] 计入业绩金额
- [ ] 创建时间(createTime)
- [ ] 签约时间(signedDate)

### 业务逻辑验证
- [ ] **5万上限逻辑**: 工单金额上限计算
- [ ] **去重逻辑**: 重复合同处理
- [ ] **累计统计**: 管家累计单数和金额
- [ ] **个人序列**: 活动期内序列计算
- [ ] **奖励计算**: 各类奖励的触发和计算

### 特殊业务逻辑验证

#### 北京特有逻辑
- [ ] **历史合同处理**: pcContractdocNum字段处理
- [ ] **管家键格式**: 使用"管家"格式
- [ ] **幸运数字逻辑**: 个人序列幸运数字

#### 上海特有逻辑  
- [ ] **双轨统计**: 平台单/自引单分类
- [ ] **项目地址去重**: 自引单地址去重
- [ ] **管家键格式**: 使用"管家_服务商"格式
- [ ] **自引单奖励**: 自引单特殊奖励逻辑

## 📝 测试执行计划

### 测试环境要求
- **数据源**: 真实Metabase API（生产环境数据）
- **数据库**: 本地SQLite数据库（测试专用）
- **对比基准**: 旧系统生成的标准输出
- **测试模式**: 影子模式（不发送消息）
- **验证工具**: 自动化对比脚本

### 完整执行步骤（端到端测试）

#### 第1步：环境初始化（必须）
1. **清空数据库**:
   - 删除所有performance_records表数据
   - 删除所有notification_queue表数据
   - 确保数据库处于干净状态
2. **验证API连接**: 确保Metabase API正常响应
3. **配置检查**: 验证所有配置文件正确
4. **日志清理**: 清空或备份旧的日志文件

#### 第2步：基准数据获取（关键）
1. **旧系统环境准备**:
   - 确保旧系统环境干净（清空其数据库）
   - 使用相同的API数据源
2. **执行旧系统**: 运行旧系统完整流程
3. **收集基准输出**:
   - CSV文件（完整的业绩数据）
   - 数据库状态（如果旧系统使用数据库）
   - 通知数据（应该发送的通知内容）
4. **基准数据验证**: 确保基准数据完整和正确

#### 第3步：新系统执行（核心）
1. **确认环境干净**: 再次确认新系统数据库为空
2. **执行新架构**: 运行新系统完整流程
3. **收集测试输出**:
   - CSV文件（新系统生成的业绩数据）
   - 数据库状态（performance_records表内容）
   - 通知队列（notification_queue表内容）
4. **执行状态检查**: 确认新系统执行无错误

#### 第4步：数据对比验证（严格）
1. **文件级对比**: CSV文件的完整对比
2. **字段级对比**: 逐字段精确验证
3. **数据库对比**: 数据库记录的完整性检查
4. **业务逻辑验证**: 复杂计算逻辑的结果验证
5. **通知内容对比**: 通知内容和发送对象的对比

#### 第5步：差异分析和修复（迭代）
1. **差异分类**: 将发现的差异按类型分类
2. **根因分析**: 分析每个差异的根本原因
3. **修复实施**: 修复发现的问题
4. **重新测试**: 从第1步重新开始完整流程

#### 第6步：最终确认（验收）
1. **完整重测**: 执行完整的端到端测试
2. **零差异确认**: 确认所有输出完全一致
3. **性能验证**: 确认性能在可接受范围内
4. **文档记录**: 记录完整的测试过程和结果

## 🛠️ 测试工具和脚本

### 环境管理工具
- `scripts/database_cleanup.py`: 数据库清理工具（必须）
- `scripts/environment_validator.py`: 环境状态验证工具
- `scripts/api_connection_tester.py`: API连接测试工具

### 核心测试脚本
- `integration_test_september_jobs.py`: 主要集成测试脚本
- `scripts/detailed_field_validator.py`: 详细字段验证工具
- `scripts/business_logic_checker.py`: 业务逻辑检查工具（待创建）
- `scripts/performance_comparator.py`: 性能对比工具（待创建）

### 基准数据管理
- `scripts/baseline_data_collector.py`: 基准数据收集工具（待创建）
- `scripts/baseline_data_validator.py`: 基准数据验证工具（待创建）

### 验证报告
- 每个Job生成独立的验证报告
- 包含详细的字段对比结果
- 记录所有发现的差异和解决方案
- 包含完整的测试执行日志

## 📈 成功标准

### 通过标准
- **数据一致性**: 99.9%以上字段完全一致
- **业务逻辑**: 100%业务逻辑结果一致
- **性能要求**: 处理时间不超过旧系统1.5倍
- **错误处理**: 无未处理异常

### 风险控制
- 每个Job独立验证，降低风险
- 发现问题立即停止，分析解决
- 保持旧系统作为备份方案
- 渐进式部署，逐步替换

## 📋 当前状态

### 已完成
- [x] 基础架构搭建
- [x] API连接验证
- [x] 初步集成测试
- [x] 环境清理

### 进行中
- [ ] 详细验证工具开发
- [ ] BJ-SEP-2025详细验证
- [ ] SH-SEP-2025详细验证

### 待开始
- [ ] 8月份Job验证
- [ ] 性能基准测试
- [ ] 生产部署准备

## 🎯 下一步行动

1. **创建详细验证工具**: 开发字段级对比工具
2. **获取基准数据**: 收集旧系统的标准输出
3. **执行BJ-SEP验证**: 完整的北京9月验证
4. **执行SH-SEP验证**: 完整的上海9月验证
5. **分析和修复**: 解决发现的任何差异

---

**负责人**: Frank & AI Assistant  
**开始日期**: 2025-01-08  
**预计完成**: 2025-01-15  
**风险等级**: 中等（可控）
