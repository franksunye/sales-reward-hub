# 北京10月活动实施检查清单

## 前置确认事项

### 数据源确认 ✅
- [x] 确认北京10月API端点：`/api/card/1883/query`
- [x] 确认包含 `sourceType` 字段（1=自引单，2=平台单）
- [x] 确认包含 `projectAddress` 字段（自引单去重用）
- [x] 确认数据格式与上海9月一致

### 业务规则确认 ✅
- [x] 幸运数字：仅基于平台单个人序号5的倍数
- [x] 节节高：基于总业绩（平台单+自引单），10个合同门槛
- [x] 消息格式：显示平台单和自引单分别统计
- [x] 自引单不需要独立奖励（与上海9月不同）

## 开发任务清单

### 阶段1：配置修改
- [ ] 修改 `modules/config.py` 中的 `BJ-2025-10` 配置
  - [ ] 设置 `reward_calculation_strategy.type: "dual_track"`
  - [ ] 设置 `lucky_number_sequence_type: "platform_only"`
  - [ ] 确认奖励阈值和金额映射

### 阶段2：核心代码扩展
- [ ] 扩展 `modules/core/reward_calculator.py`
  - [ ] 添加 `platform_only` 幸运数字计算逻辑
  - [ ] 添加边界条件检查
- [ ] 扩展 `modules/core/notification_service.py`
  - [ ] 添加北京10月专用消息模板
  - [ ] 实现双轨统计数据显示

### 阶段3：Job函数开发
- [ ] 创建 `modules/core/beijing_jobs.py` 中的新函数
  - [ ] `signing_and_sales_incentive_oct_beijing_v2()`
  - [ ] 配置 `enable_dual_track=True`
  - [ ] 配置 `enable_historical_contracts=False`

### 阶段4：测试开发
- [ ] 单元测试
  - [ ] 幸运数字计算测试
  - [ ] 节节高计算测试
  - [ ] 消息模板生成测试
- [ ] 集成测试
  - [ ] 端到端流程测试
  - [ ] 双轨统计验证测试

## 代码修改要点

### 配置文件关键修改
```python
"BJ-2025-10": {
    "lucky_number_sequence_type": "platform_only",  # 新增
    "reward_calculation_strategy": {
        "type": "dual_track",  # 修改
        "rules": {
            "default": {
                "enable_tiered_rewards": True,
                "stats_source": "total"  # 节节高使用总统计
            }
        }
    }
}
```

### RewardCalculator关键修改
```python
# 在 _determine_lucky_number_reward 方法中添加
if lucky_sequence_type == "platform_only":
    platform_sequence = housekeeper_stats.platform_count
    if platform_sequence > 0 and platform_sequence % lucky_number == 0:
        return "幸运数字", "接好运"
```

### NotificationService关键修改
```python
# 在 _send_group_notification 方法中添加
if self.config.config_key == "BJ-2025-10":
    # 北京10月专用消息模板
    # 显示双轨统计信息
```

## 测试验证清单

### 功能测试
- [ ] 幸运数字只基于平台单序号计算
- [ ] 节节高基于总业绩计算
- [ ] 消息显示双轨统计信息
- [ ] 工单金额上限正确应用

### 边界测试
- [ ] 只有自引单，无平台单的情况
- [ ] 只有平台单，无自引单的情况
- [ ] 合同数量刚好达到门槛的情况
- [ ] 业绩金额刚好达到阈值的情况

### 兼容性测试
- [ ] 不影响北京9月功能
- [ ] 不影响上海9月功能
- [ ] 数据库结构兼容
- [ ] 通知系统兼容

## 部署检查清单

### 部署前检查
- [ ] 所有单元测试通过
- [ ] 集成测试验证完成
- [ ] 代码审查通过
- [ ] 配置文件更新完成
- [ ] 数据库迁移（如需要）

### 部署后验证
- [ ] 服务启动正常
- [ ] 数据库连接正常
- [ ] API接口可访问
- [ ] 日志记录正常
- [ ] 监控指标正常

### 业务验证
- [ ] 使用测试数据验证完整流程
- [ ] 确认消息格式正确
- [ ] 确认奖励计算正确
- [ ] 确认通知发送正常

## 监控指标

### 业务指标
- [ ] 处理合同数量
- [ ] 平台单/自引单比例
- [ ] 幸运数字触发次数
- [ ] 节节高奖励发放次数
- [ ] 消息发送成功率

### 技术指标
- [ ] 处理耗时
- [ ] 内存使用量
- [ ] 数据库查询性能
- [ ] 异常错误率

## 风险缓解措施

### 数据风险
- [ ] 数据源字段缺失的备用方案
- [ ] 数据格式异常的处理逻辑
- [ ] 数据量异常的告警机制

### 业务风险
- [ ] 奖励计算错误的回滚方案
- [ ] 消息发送失败的重试机制
- [ ] 业务规则变更的快速响应

### 技术风险
- [ ] 性能问题的优化方案
- [ ] 系统异常的监控告警
- [ ] 代码缺陷的快速修复

## 上线时间规划

### 第1周：开发阶段
- 周一-周二：配置修改和核心代码开发
- 周三-周四：Job函数开发和单元测试
- 周五：代码审查和集成测试

### 第2周：测试阶段
- 周一-周二：功能测试和边界测试
- 周三-周四：兼容性测试和性能测试
- 周五：测试报告和部署准备

### 第3周：部署阶段
- 周一：预生产环境部署和验证
- 周二-周三：生产环境部署
- 周四-周五：监控和问题修复

## 联系人信息

### 技术团队
- 开发负责人：[待填写]
- 测试负责人：[待填写]
- 运维负责人：[待填写]

### 业务团队
- 产品负责人：[待填写]
- 业务确认人：王爽
- 运营负责人：[待填写]

### 数据团队
- 数据源负责人：[待填写]
- API维护人：[待填写]

---

**检查清单版本**: v1.0  
**创建日期**: 2025-01-28  
**适用范围**: 北京2025年10月销售激励活动  
**更新频率**: 根据开发进度实时更新
