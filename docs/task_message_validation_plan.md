# Task消息生成验证计划

## 验证目标

确保新架构与旧架构在Task消息生成方面的**完全等价性**，包括：

1. **消息模板完全一致**：通知文本格式、结构相同
2. **动态数据填充准确**：业绩数据、奖励金额、累计统计等数值准确
3. **通知触发条件一致**：何时发送、发送给谁、发送什么类型的消息
4. **数据处理与消息生成解耦**：修改消息生成不影响数据处理

## 验证范围

### 城市和活动
- **北京9月活动** (`BJ-SEP`)
- **上海9月活动** (`SH-SEP`)

### 验证维度

#### 1. 配置一致性
- 奖励规则配置（门槛、金额、类型）
- 业务规则配置（幸运数字、金额上限、双轨统计）
- API端点配置（Metabase数据源）

#### 2. 数据处理一致性
- PerformanceData生成结果对比
- 业绩计算逻辑验证
- 奖励状态判断逻辑

#### 3. 消息生成一致性
- Task数量对比
- 消息内容逐字对比
- 接收人列表对比
- 任务类型分布对比

## 验证工具

### 1. 快速验证工具 (`scripts/quick_validation.py`)
**用途**：快速验证关键指标
```bash
# 验证北京
python scripts/quick_validation.py --city BJ

# 验证上海
python scripts/quick_validation.py --city SH

# 验证全部
python scripts/quick_validation.py --all
```

**输出**：
- 任务数量对比
- 业绩记录数量对比
- 奖励类型分布对比
- 等价性判断结果

### 2. 详细验证工具 (`scripts/task_message_validation.py`)
**用途**：深度验证消息内容
```bash
# 验证配置一致性
python scripts/task_message_validation.py --validate-config

# 验证指定城市
python scripts/task_message_validation.py --city BJ --activity BJ-SEP

# 全面验证
python scripts/task_message_validation.py --compare-all

# 干运行（仅验证配置）
python scripts/task_message_validation.py --compare-all --dry-run
```

**输出**：
- PerformanceData字段级对比
- Task消息逐条对比
- 动态数据填充验证
- 详细差异报告

### 3. 消息内容分析工具 (`scripts/message_content_analyzer.py`)
**用途**：分析消息结构和模板
```bash
# 分析消息结构
python scripts/message_content_analyzer.py --analyze-messages

# 提取消息模板
python scripts/message_content_analyzer.py --extract-templates

# 保存分析报告
python scripts/message_content_analyzer.py --analyze-messages --output analysis_report.json
```

**输出**：
- 消息模板提取
- 动态数据字段识别
- 任务类型分布分析
- 接收人统计

## 验证流程

### 阶段1：环境准备
1. 清理现有数据库文件
2. 初始化测试数据库
3. 验证配置文件一致性

### 阶段2：基线数据生成
1. 运行旧架构获取基线数据
2. 记录PerformanceData结果
3. 记录Task消息结果
4. 保存基线统计信息

### 阶段3：新架构数据生成
1. 清理环境重新初始化
2. 运行新架构生成对比数据
3. 调用通知模块生成Task消息
4. 记录新架构统计信息

### 阶段4：结果对比
1. **数量级对比**：记录数、任务数、管家数
2. **结构对比**：字段结构、任务类型分布
3. **内容对比**：消息文本逐字对比
4. **逻辑对比**：奖励触发条件、计算逻辑

### 阶段5：差异分析
1. 识别关键差异点
2. 分析差异原因
3. 判断是否为设计差异
4. 生成修复建议

## 关键验证点

### 北京9月特有逻辑
- ✅ 历史合同处理
- ✅ 工单金额上限（5万）
- ✅ 合同金额上限（5万）
- ✅ 幸运数字5（个人序号倍数）
- ✅ 10个合同门槛

### 上海9月特有逻辑
- ✅ 双轨统计（平台单/自引单）
- ✅ 项目地址去重（仅自引单）
- ✅ 自引单红包奖励（50元）
- ✅ 5个合同门槛
- ✅ 无金额上限

### 通用验证点
- ✅ 消息模板格式
- ✅ 动态数据准确性
- ✅ 奖励计算逻辑
- ✅ 累计统计准确性
- ✅ 通知发送条件

## 预期结果

### 成功标准
1. **任务数量完全匹配**：新旧架构生成相同数量的Task
2. **消息内容完全一致**：逐字对比无差异
3. **接收人列表一致**：相同的人收到相同的消息
4. **业绩数据一致**：PerformanceData记录完全匹配

### 可接受的差异
1. **时间戳差异**：创建时间可能不同
2. **ID差异**：数据库自增ID可能不同
3. **字段顺序差异**：CSV字段顺序可能不同
4. **技术实现差异**：存储方式不同但结果相同

### 不可接受的差异
1. **消息内容差异**：任何文本内容不一致
2. **数量差异**：任务数量或记录数量不匹配
3. **逻辑差异**：奖励计算结果不同
4. **接收人差异**：通知发送对象不同

## 故障排除

### 常见问题
1. **数据库连接失败**：检查数据库文件权限
2. **API调用失败**：检查网络连接和API配置
3. **配置读取失败**：检查配置文件格式
4. **模块导入失败**：检查Python路径设置

### 调试方法
1. **启用详细日志**：设置日志级别为DEBUG
2. **分步执行**：单独运行各个阶段
3. **数据检查**：手动检查中间结果文件
4. **配置验证**：使用配置验证工具

## 执行建议

### 验证顺序
1. **先验证配置**：确保配置文件正确
2. **单城市验证**：先验证一个城市
3. **全面验证**：验证所有城市
4. **深度分析**：使用分析工具详细检查

### 性能考虑
- 使用真实数据源可能较慢
- 可以先用小数据集测试
- 并行验证不同城市
- 保存中间结果避免重复计算

### 结果保存
- 保存验证报告到`docs/validation_reports/`
- 记录验证时间和环境信息
- 保存差异详情用于后续分析
- 建立验证历史记录

## 总结

通过这套完整的验证方案，我们可以：

1. **确保等价性**：新旧架构Task消息生成完全一致
2. **保证质量**：通过多维度验证确保无遗漏
3. **支持迭代**：验证工具可重复使用
4. **便于调试**：详细的差异分析帮助快速定位问题

验证通过后，可以确信新架构在消息生成方面与旧架构完全等价，为后续的架构迁移提供可靠保障。
