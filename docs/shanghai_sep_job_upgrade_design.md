# ä¸Šæµ·9æœˆç­¾çº¦æ¿€åŠ±Jobå‡çº§è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **Jobåç§°**: `signing_and_sales_incentive_sep_shanghai()`
- **åˆ›å»ºæ—¥æœŸ**: 2025-08-29
- **ç‰ˆæœ¬**: v1.0
- **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ
- **åŸºäº**: ä¸Šæµ·8æœˆjob (`signing_and_sales_incentive_aug_shanghai`)

## 1. å‡çº§æ¦‚è¿°

### 1.1 æ ¸å¿ƒå˜åŒ–
- **æ•°æ®æºå‡çº§**: æ–°å¢4ä¸ªå­—æ®µæ”¯æŒè‡ªå¼•å•å’Œå¹³å°å•åŒºåˆ†
- **ä¸šåŠ¡é€»è¾‘å‡çº§**: å¼•å…¥è‡ªå¼•å•å¥–åŠ±æœºåˆ¶
- **é€šçŸ¥æ¶ˆæ¯å‡çº§**: åŒºåˆ†è‡ªå¼•å•å’Œå¹³å°å•çš„æ’­æŠ¥æ ¼å¼
- **å°è´¦ç»“æ„å‡çº§**: æ–°å¢è‡ªå¼•å•ç›¸å…³ç»Ÿè®¡å­—æ®µ

### 1.2 æ–°å¢å­—æ®µ
æ ¹æ®æ•°æ®æº http://metabase.fsgo365.cn:3000/question/1838 çš„ç»“æ„å˜åŒ–ï¼š
- `serviceHousekeeperId`: ç®¡å®¶ID
- `sourceType`: å·¥å•ç±»å‹ (1=è‡ªå¼•å•, 2/4/5=å¹³å°å•)
- `contactsAddress`: å®¢æˆ·è”ç³»åœ°å€
- `projectAddress`: é¡¹ç›®åœ°å€

### 1.3 ä¸šåŠ¡è§„åˆ™å˜åŒ–
- **å¹³å°å•**: ä¿æŒåŸæœ‰é€»è¾‘ä¸å˜ï¼ˆèŠ‚èŠ‚é«˜å¥–åŠ±ä½“ç³»ï¼‰
- **è‡ªå¼•å•**: æ–°å¢ç‹¬ç«‹å¥–åŠ±æœºåˆ¶ï¼ˆæ¯ä¸ªåˆæ ¼è‡ªå¼•å•50å…ƒçº¢åŒ…ï¼‰
- **åˆæ ¼è‡ªå¼•å•**: é¡¹ç›®åœ°å€ï¼ˆprojectAddressï¼‰å”¯ä¸€æ€§åˆ¤æ–­

## 2. æŠ€æœ¯æ¶æ„å‡çº§

### 2.1 æ–°å¢ç»„ä»¶
```
signing_and_sales_incentive_sep_shanghai()
â”œâ”€â”€ æ•°æ®è·å–å±‚: send_request_with_managed_session() [å‡çº§]
â”œâ”€â”€ æ•°æ®å¤„ç†å±‚: process_data_shanghai_sep() [æ–°å»º]
â”œâ”€â”€ å¹³å°å•å¥–åŠ±è®¡ç®—: determine_rewards_apr_shanghai_generic() [å¤ç”¨]
â”œâ”€â”€ è‡ªå¼•å•å¥–åŠ±è®¡ç®—: determine_self_referral_rewards() [æ–°å»º]
â”œâ”€â”€ é€šçŸ¥å‘é€å±‚: notify_awards_shanghai_sep() [æ–°å»º]
â””â”€â”€ æ–‡ä»¶ç®¡ç†å±‚: archive_file() [å¤ç”¨]
```

### 2.2 æ•°æ®æµå‘å‡çº§
```
Metabase API â†’ CSVä¸´æ—¶æ–‡ä»¶ â†’ æ•°æ®åˆ†ç±»å¤„ç† â†’ åŒè½¨å¥–åŠ±è®¡ç®— â†’ ç»Ÿä¸€é€šçŸ¥å‘é€ â†’ æ–‡ä»¶å½’æ¡£
                    â†“
            [å¹³å°å•] + [è‡ªå¼•å•]
                â†“         â†“
        èŠ‚èŠ‚é«˜å¥–åŠ±    é¡¹ç›®åœ°å€å»é‡å¥–åŠ±
                â†“         â†“
            ç»Ÿä¸€å°è´¦è®°å½•å’Œé€šçŸ¥
```

## 3. æ•°æ®ç»“æ„å‡çº§

### 3.1 APIå“åº”æ•°æ®ç»“æ„ï¼ˆæ–°å¢å­—æ®µï¼‰
```json
{
  "data": {
    "rows": [
      [
        // ... åŸæœ‰17ä¸ªå­—æ®µ ...
        "housekeeper_id_001",           // serviceHousekeeperId
        "1",                            // sourceType (1=è‡ªå¼•å•, 2/4/5=å¹³å°å•)
        "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºå¼ æ±Ÿè·¯123å·",      // contactsAddress
        "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºç§‘æŠ€å›­456å·"       // projectAddress
      ]
    ]
  }
}
```

### 3.2 CSVæ–‡ä»¶æ•°æ®ç»“æ„å‡çº§

#### 3.2.1 åŸå§‹åˆåŒæ•°æ®æ–‡ä»¶ (ContractData-SH-Sep.csv)
```csv
åˆåŒID(_id),æ´»åŠ¨åŸå¸‚(province),...,å¹³å‡å®¢å•ä»·(average),ç®¡å®¶ID(serviceHousekeeperId),å·¥å•ç±»å‹(sourceType),å®¢æˆ·è”ç³»åœ°å€(contactsAddress),é¡¹ç›®åœ°å€(projectAddress)
```

**æ–°å¢å­—æ®µè¯´æ˜**ï¼š
- `ç®¡å®¶ID(serviceHousekeeperId)`: ç®¡å®¶å”¯ä¸€æ ‡è¯† (String)
- `å·¥å•ç±»å‹(sourceType)`: 1=è‡ªå¼•å•, 2/4/5=å¹³å°å• (Integer)
- `å®¢æˆ·è”ç³»åœ°å€(contactsAddress)`: å®¢æˆ·è”ç³»åœ°å€ (String)
- `é¡¹ç›®åœ°å€(projectAddress)`: é¡¹ç›®åœ°å€ï¼Œç”¨äºè‡ªå¼•å•å»é‡ (String)

#### 3.2.2 ä¸šç»©æ•°æ®æ–‡ä»¶ (PerformanceData-SH-Sep.csv)
```csv
æ´»åŠ¨ç¼–å·,åˆåŒID(_id),...,ç™»è®°æ—¶é—´,å·¥å•ç±»å‹,é¡¹ç›®åœ°å€,å¹³å°å•ç´¯è®¡æ•°é‡,å¹³å°å•ç´¯è®¡é‡‘é¢,è‡ªå¼•å•ç´¯è®¡æ•°é‡,è‡ªå¼•å•ç´¯è®¡é‡‘é¢,è‡ªå¼•å•å¥–åŠ±ç±»å‹,è‡ªå¼•å•å¥–åŠ±åç§°
```

**æ–°å¢è®¡ç®—å­—æ®µè¯´æ˜**ï¼š
- `å·¥å•ç±»å‹`: è‡ªå¼•å•/å¹³å°å• (String)
- `é¡¹ç›®åœ°å€`: é¡¹ç›®åœ°å€ï¼Œç”¨äºè‡ªå¼•å•å»é‡ (String)
- `å¹³å°å•ç´¯è®¡æ•°é‡`: ç®¡å®¶å¹³å°å•ç´¯è®¡æ•°é‡ (Integer)
- `å¹³å°å•ç´¯è®¡é‡‘é¢`: ç®¡å®¶å¹³å°å•ç´¯è®¡é‡‘é¢ (Float)
- `è‡ªå¼•å•ç´¯è®¡æ•°é‡`: ç®¡å®¶è‡ªå¼•å•ç´¯è®¡æ•°é‡ (Integer)
- `è‡ªå¼•å•ç´¯è®¡é‡‘é¢`: ç®¡å®¶è‡ªå¼•å•ç´¯è®¡é‡‘é¢ (Float)
- `è‡ªå¼•å•å¥–åŠ±ç±»å‹`: "è‡ªå¼•å•" æˆ– ç©º (String)
- `è‡ªå¼•å•å¥–åŠ±åç§°`: "çº¢åŒ…" æˆ– ç©º (String)

### 3.3 å†…å­˜æ•°æ®ç»“æ„å‡çº§

#### 3.3.1 ç®¡å®¶åˆåŒæ•°æ®ç»“æ„
```python
housekeeper_contracts = {
    "å¼ ä¸‰_ä¸Šæµ·è‹±æ£®é˜²æ°´å·¥ç¨‹æœ‰é™å…¬å¸": {
        'platform_count': 3,              # å¹³å°å•æ•°é‡
        'platform_amount': 45000.0,       # å¹³å°å•ç´¯è®¡é‡‘é¢
        'platform_performance_amount': 45000.0,  # å¹³å°å•ä¸šç»©é‡‘é¢
        'self_referral_count': 2,          # è‡ªå¼•å•æ•°é‡
        'self_referral_amount': 15000.0,   # è‡ªå¼•å•ç´¯è®¡é‡‘é¢
        'awarded': ["åŸºç¡€å¥–"],             # å¹³å°å•å·²è·å¾—å¥–åŠ±
        'self_referral_projects': set(),   # è‡ªå¼•å•é¡¹ç›®åœ°å€é›†åˆï¼ˆå»é‡ç”¨ï¼‰
        'self_referral_rewards': 0         # è‡ªå¼•å•å¥–åŠ±æ•°é‡
    }
}
```

#### 3.3.2 è‡ªå¼•å•å¥–åŠ±è®¡ç®—è¿”å›ç»“æ„
```python
# determine_self_referral_rewards() è¿”å›å€¼
(
    "è‡ªå¼•å•",                    # reward_type (String)
    "çº¢åŒ…",                      # reward_name (String)
    True                        # is_qualified (Boolean)
)
```

## 4. æ ¸å¿ƒåŠŸèƒ½å‡çº§

### 4.1 æ•°æ®å¤„ç†å‡½æ•° - process_data_shanghai_sep()
**æ–°å»ºå‡½æ•°ï¼ŒåŸºäº process_data_shanghai_apr() å‡çº§**

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. æŒ‰ sourceType å­—æ®µåˆ†ç±»å¤„ç†åˆåŒ
2. å¹³å°å•ï¼šå¤ç”¨åŸæœ‰é€»è¾‘è®¡ç®—èŠ‚èŠ‚é«˜å¥–åŠ±
3. è‡ªå¼•å•ï¼šæŒ‰é¡¹ç›®åœ°å€å»é‡ï¼Œç¬¦åˆæ¡ä»¶çš„å‘æ”¾çº¢åŒ…å¥–åŠ±
4. ç»Ÿä¸€è®°å½•åˆ°ä¸šç»©å°è´¦

**å…³é”®å¤„ç†æ­¥éª¤**ï¼š
```python
def process_data_shanghai_sep(contract_data, existing_contract_ids, housekeeper_award_lists):
    # 1. åˆå§‹åŒ–æ•°æ®ç»“æ„
    # 2. éå†åˆåŒæ•°æ®
    for contract in contract_data:
        source_type = contract['å·¥å•ç±»å‹(sourceType)']
        if source_type == 1:
            # è‡ªå¼•å•å¤„ç†é€»è¾‘
            process_self_referral_contract(contract, housekeeper_contracts)
        else:
            # å¹³å°å•å¤„ç†é€»è¾‘ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
            process_platform_contract(contract, housekeeper_contracts)
    # 3. ç”Ÿæˆä¸šç»©æ•°æ®
    # 4. è¿”å›å¤„ç†ç»“æœ
```

### 4.2 è‡ªå¼•å•å¥–åŠ±è®¡ç®— - determine_self_referral_rewards()
**æ–°å»ºå‡½æ•°**

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
def determine_self_referral_rewards(project_address, housekeeper_data):
    """
    è‡ªå¼•å•å¥–åŠ±è®¡ç®—å‡½æ•°
    
    Args:
        project_address: é¡¹ç›®åœ°å€
        housekeeper_data: ç®¡å®¶æ•°æ®
    
    Returns:
        tuple: (reward_type, reward_name, is_qualified)
    """
    # æ£€æŸ¥é¡¹ç›®åœ°å€æ˜¯å¦å·²å­˜åœ¨
    if project_address not in housekeeper_data['self_referral_projects']:
        housekeeper_data['self_referral_projects'].add(project_address)
        housekeeper_data['self_referral_rewards'] += 1
        return ("è‡ªå¼•å•", "çº¢åŒ…", True)
    else:
        return ("", "", False)
```

### 4.3 é€šçŸ¥å‘é€å‡çº§ - notify_awards_shanghai_sep()
**æ–°å»ºå‡½æ•°ï¼ŒåŸºäº notify_awards_shanghai_generate_message_march() å‡çº§**

**ç¾¤é€šçŸ¥æ¶ˆæ¯æ ¼å¼**ï¼š
```
ğŸ§¨ğŸ§¨ğŸ§¨ ç­¾çº¦å–œæŠ¥ ğŸ§¨ğŸ§¨ğŸ§¨

æ­å–œ {ç®¡å®¶åç§°} ç­¾çº¦åˆåŒï¼ˆ{å¹³å°å•/è‡ªå¼•å•}ï¼‰ {åˆåŒç¼–å·} å¹¶å®Œæˆçº¿ä¸Šæ”¶æ¬¾ğŸ‰ğŸ‰ğŸ‰

ğŸŒ» æœ¬å•ä¸ºæœ¬æœˆå¹³å°ç´¯è®¡ç­¾çº¦ç¬¬ {å¹³å°å•åºå·} å•ï¼Œ

ğŸŒ» ä¸ªäººç´¯è®¡ç­¾çº¦å¹³å°å•ç¬¬ {ä¸ªäººå¹³å°å•æ•°é‡} å•ï¼Œ ä¸ªäººç´¯è®¡ç­¾çº¦è‡ªå¼•å•ç¬¬ {ä¸ªäººè‡ªå¼•å•æ•°é‡} å•ã€‚
ğŸŒ» ä¸ªäººç´¯è®¡ç­¾çº¦å¹³å°å•é‡‘é¢ {å¹³å°å•é‡‘é¢} å…ƒï¼Œè‡ªå¼•å•é‡‘é¢{è‡ªå¼•å•é‡‘é¢}å…ƒ

ğŸŒ» ä¸ªäººå¹³å°å•è½¬åŒ–ç‡ {è½¬åŒ–ç‡}%ï¼Œ

ğŸ‘Š {å¥–åŠ±çŠ¶æ€æè¿°} ğŸ‰ğŸ‰ğŸ‰ã€‚
```

**ä¸ªäººå¥–åŠ±æ¶ˆæ¯æ ¼å¼**ï¼š
- å¹³å°å•å¥–åŠ±ï¼šä¿æŒåŸæœ‰æ ¼å¼
- è‡ªå¼•å•å¥–åŠ±ï¼š
```
ğŸ‰ æ­å–œè·å¾—è‡ªå¼•å•å¥–åŠ±ï¼
å¥–åŠ±ç±»å‹ï¼šè‡ªå¼•å•
å¥–åŠ±åç§°ï¼šçº¢åŒ…
å¥–åŠ±é‡‘é¢ï¼š50 å…ƒ
```

## 5. é…ç½®å‡çº§

### 5.1 æ–°å¢é…ç½®é¡¹
```python
# APIé…ç½®
API_URL_SH_SEP = METABASE_URL + "/api/card/1838/query"

# æ–‡ä»¶è·¯å¾„
TEMP_CONTRACT_DATA_FILE_SH_SEP = 'state/ContractData-SH-Sep.csv'
PERFORMANCE_DATA_FILENAME_SH_SEP = 'state/PerformanceData-SH-Sep.csv'
STATUS_FILENAME_SH_SEP = 'state/send_status_sh_sep.json'

# è‡ªå¼•å•å¥–åŠ±é…ç½®
SELF_REFERRAL_REWARD_AMOUNT = 50  # è‡ªå¼•å•å¥–åŠ±é‡‘é¢
SELF_REFERRAL_REWARD_TYPE = "è‡ªå¼•å•"
SELF_REFERRAL_REWARD_NAME = "çº¢åŒ…"

# é€šçŸ¥é…ç½®
WECOM_GROUP_NAME_SH_SEP = 'ï¼ˆä¸Šæµ·ï¼‰è¿è¥ç¾¤'
CAMPAIGN_CONTACT_SH_SEP = 'æ»¡æµ©æµ©'
```

## 6. å®æ–½è®¡åˆ’

### 6.1 å¼€å‘é˜¶æ®µ
1. **Phase 1**: æ•°æ®ç»“æ„å‡çº§å’Œé…ç½®æ·»åŠ 
2. **Phase 2**: æ ¸å¿ƒå¤„ç†å‡½æ•°å¼€å‘
3. **Phase 3**: é€šçŸ¥æ¶ˆæ¯å‡çº§
4. **Phase 4**: é›†æˆæµ‹è¯•å’ŒéªŒè¯

### 6.2 æµ‹è¯•è¦ç‚¹
- **æ•°æ®åˆ†ç±»æ­£ç¡®æ€§**: sourceTypeå­—æ®µæ­£ç¡®è¯†åˆ«
- **è‡ªå¼•å•å»é‡é€»è¾‘**: é¡¹ç›®åœ°å€å”¯ä¸€æ€§éªŒè¯
- **å¹³å°å•é€»è¾‘ä¿æŒ**: åŸæœ‰èŠ‚èŠ‚é«˜å¥–åŠ±ä¸å—å½±å“
- **é€šçŸ¥æ¶ˆæ¯æ ¼å¼**: æ–°æ ¼å¼æ­£ç¡®æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
- **å°è´¦æ•°æ®å®Œæ•´æ€§**: æ‰€æœ‰æ–°å¢å­—æ®µæ­£ç¡®è®°å½•

### 6.3 é£é™©è¯„ä¼°
- **æ•°æ®æºå˜åŒ–é£é™©**: éœ€è¦ç¡®è®¤æ–°å­—æ®µçš„æ•°æ®è´¨é‡
- **é€»è¾‘å¤æ‚åº¦å¢åŠ **: åŒè½¨å¤„ç†å¯èƒ½å¢åŠ å‡ºé”™æ¦‚ç‡
- **å‘åå…¼å®¹æ€§**: ç¡®ä¿ä¸å½±å“å…¶ä»–æœˆä»½çš„job

## 7. åç»­ä¼˜åŒ–å»ºè®®

### 7.1 ä»£ç å¤ç”¨ä¼˜åŒ–
- æŠ½è±¡é€šç”¨çš„åˆåŒå¤„ç†é€»è¾‘
- ç»Ÿä¸€å¥–åŠ±è®¡ç®—æ¥å£
- ä¼˜åŒ–é€šçŸ¥æ¶ˆæ¯æ¨¡æ¿ç³»ç»Ÿ

### 7.2 ç›‘æ§å¢å¼º
- æ–°å¢è‡ªå¼•å•å¤„ç†ç›‘æ§æŒ‡æ ‡
- é¡¹ç›®åœ°å€å»é‡æ•ˆæœç›‘æ§
- åŒè½¨å¥–åŠ±å‘æ”¾å‡†ç¡®æ€§ç›‘æ§

---
*æœ¬è®¾è®¡æ–‡æ¡£éµå¾ªKISSåŸåˆ™ï¼Œä¸“æ³¨æ ¸å¿ƒå‡çº§è¦ç‚¹ã€‚è¯¦ç»†å®ç°è¯·å‚è€ƒç°æœ‰ä»£ç æ¨¡å¼ã€‚*
